name: Build u-boot for GXBB

on:
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive  # 重要：包含子模块

    - name: Setup ARM Toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-linux-gnueabihf gcc-aarch64-linux-gnu
        sudo apt-get install -y make git bison flex libssl-dev device-tree-compiler

    - name: Build u-boot for GXBB (M13)
      run: |
        cd u-boot
        
        echo "=== 查看所有可用配置 ==="
        ls configs/ | grep -i "gxbb\|p200\|p212" || echo "找不到配置，列出所有："
        ls configs/ | head -20
        
        echo "=== 尝试编译 ==="
        make distclean
        
        # 尝试几个可能的配置
        if [ -f configs/gxbb_p200_1gbit_defconfig ]; then
          make gxbb_p200_1gbit_defconfig
        elif [ -f configs/gxbb_p200_defconfig ]; then
          make gxbb_p200_defconfig
        elif [ -f configs/gxbb_p212_defconfig ]; then
          make gxbb_p212_defconfig
        elif [ -f configs/p200_defconfig ]; then
          make p200_defconfig
        else
          # 使用第一个找到的配置
          FIRST_CONFIG=$(ls configs/ | head -1)
          make $FIRST_CONFIG
        fi
        
        make -j4 CROSS_COMPILE=arm-linux-gnueabihf-
        
        echo "=== 编译完成 ==="
        ls -lh u-boot.bin
        
        # 直接输出文件内容（base64编码）
        echo "=== 文件base64编码（复制到下面解码） ==="
        base64 u-boot.bin | head -20

    - name: Output u-boot.bin
      run: |
        cd u-boot
        if [ -f u-boot.bin ]; then
          echo "文件大小：$(wc -c < u-boot.bin) bytes"
          # 将文件保存到workspace以便后续步骤使用
          cp u-boot.bin ${{ github.workspace }}/
        else
          echo "错误：未生成 u-boot.bin"
          exit 1
        fi

    - name: Upload u-boot.bin
      uses: actions/upload-artifact@v4
      with:
        name: u-boot-binary
        path: u-boot.bin
